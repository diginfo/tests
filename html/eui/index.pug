extends layout

mixin sysmenu()
  if req.isMember('SYSADM')
    #sysmenu
      div#sysdebug(iconCls="icon-bug") Enable Debug
      div#syslogin(iconCls="icon-lock") Disable Logins
      div#sysrestart(iconCls="icon-engine") Restart Engine(s)
      div(iconCls="icon-module")
        span Reload Module
        div
          each mod in $.menus
            div(iconCls=mod.iconCls id='mod_'+mod.id)=mod.text
    
    script(defer).
      $('#sysmenu').menu({
        onClick:function(item){
          switch(item.id){
            case 'sysdebug':
              ajaxget('/',{_func:'debug'},function(res){
                msgbox(res.msg);
              })              
              break;
            
            case 'syslogin':
              var me = $('#syslogin');
              me.toggleClass('fg-red');
              ajaxget('/',{_func:'nologins','status':me.hasClass('fg-red')},function(res){
                if(res.msg) var msg = 'Logins disabled.'; else var msg = 'Logins enabled.';
                alert(msg);
              });
              break;
            
            case 'sysrestart':
              function go(all){
                // this won't work as msqlid must have __sqlid and index.js checks isadmin.
                if(all) var vars = {_func:'multisqlid', __func:'restart'};
                else var vars = {_func:'restart'};    
                ajaxget('/',vars,function(res){
                  alert(res.msg);
                })
              }
              
              $.messager.confirm({
              	title: 'Pure Engine Restart',
              	msg: 'Restart all Engines ?',
              	ok: 'Yes',
              	cancel: 'No',
              	fn: go
              });
            
              break;
            
            default:
              var bits = item.id.split('_');
              if(bits[0]=='mod') ajaxget('/',{_func:'reload',modid:bits[1]},function(res){
                alert(res.msg);
              })              
              break;
          }
          
        }
      });
      
      $('#sysbut').menubutton({
        menu:     '#sysmenu',
        iconCls:  'icon-server'
      })

mixin sysbut()
  if req.isMember('SYSADM')
    a#sysbut
    span.vert-sep

mixin mainleft()
  div#mainleft()
    a.on#but_logout.easyui-linkbutton(href='#' data-options="iconCls:'aicon-logout',disabled:false,plain:true")
    a.on#but_fbak.easyui-linkbutton(href='#' style="margin-left:0px;" title="Contact Support" data-options="iconCls:'aicon-feedback',disabled:false,plain:true,onClick:feedback")
    a.on#but_rst.easyui-linkbutton(href='javascript:location.href="/?_nocache=y";' title="Clear Cache & Reload" data-options="iconCls:'icon-reload',disabled:false,plain:true")      
      
mixin westmenu()
  ul#westMenu.hide
    - var _menus = JSON.parse(menus);
    each l0 in _menus
      if l0.on == 'y'
        li(iconCls=l0.iconCls id=l0.id data-options=l0.attributes)
          span=l0.text
          ul
            if(l0.children)
              each l1 in l0.children 
                if(l1.on == 'y') 
                  li(iconCls=l1.iconCls id=l1.id data-options=l1.attributes)
                    span=l1.text
                    ul
                      if(l1.children)
                        each l2 in l1.children 
                          if(l2.on == 'y')  
                            li(off=l2.off iconCls=l2.iconCls id=l2.id data-options=l2.attributes)
                              span=l2.text
                          
mixin mainmenu()
  div#mainmenu()
    - var _menus = JSON.parse(menus);
    each l0 in _menus
      if l0.on == 'y'
        -var mid = l0.id+'_men'; if(!l0.attributes) l0.attributes = {}; l0.attributes.menu='#'+mid;
        a.easyui-menubutton(href="javascript:void(0)" iconCls=l0.iconCls id=l0.id data-options=l0.attributes)=l0.text
        div(id=mid class="easyui-menu hide mainmenu")
          each l1 in l0.children 
            if(l1.on == 'y')
              -if(!l1.attributes) l1.attributes = {};
              if(l1.children && l1.children.length > 0)
                div(off=l1.off iconCls=l1.iconCls id=l1.id data-options=l1.attributes data-parent=l0.id)
                  span=l1.text
                  div
                    each l2 in l1.children 
                      if(l2.on == 'y')
                        -if(!l2.attributes) l2.attributes = {};
                        if(l2.children && l2.children.length > 0)
                          div(off=l2.off iconCls=l2.iconCls id=l2.id data-options=l2.attributes data-parent=l1.id)
                            span=l2.text
                            div
                        else 
                          div(off=l2.off iconCls=l2.iconCls id=l2.id data-options=l2.attributes data-parent=l1.id)=l2.text
              else
                div(iconCls=l1.iconCls id=l1.id data-options=l1.attributes data-parent=l1.id)=l1.text  

  
mixin mainright()
  div#mainright()
    //-if(isdev)
      //-a.tbut.on#but_upload.easyui-linkbutton(href='#' data-options="disabled:false,iconCls:'icon-save'") Upload
      a.tbut.on.but_help#but_help.easyui-linkbutton(href='#' title="Help" data-options="disabled:false,iconCls:'icon-help'")
      span.vert-sep
    
    a.tbut#but_add.easyui-linkbutton(href='#' title="Add New" data-options="iconCls:'icon-add'")
    a.tbut#but_addm.easyui-menubutton(href='#' title="Add New" data-options="iconCls:'icon-add'" style="display:none")
    a.tbut#but_save.easyui-linkbutton(href='#' title="Save" data-options="iconCls:'icon-save'")
    a.tbut#but_del.easyui-linkbutton(href='#' title="Delete" data-options="iconCls:'aicon-trash'")        
    span.vert-sep
    a.on#but_bak.easyui-linkbutton(href='#' title="Back" data-options="iconCls:'aicon-return',disabled:false,plain:true")
    a.tbut#but_clr.easyui-linkbutton(href='#' title="Cancel" data-options="iconCls:'aicon-cancel'")
    span.vert-sep
    #but_print.easyui-menubutton(href='#' title="Reports" data-options="iconCls:'icon-print',menu:'#printmen',disabled:true")
  
block content
  //-console.log(udata); //screen: { width: '1920', height: '1080' } }

  -
    if(!udata.menu_locn) udata.menu_locn='auto'; 
    var small=false; 
    if(udata.screen.width < 1920) small=true;

    //fn.cl(req.isMember('SYSADM'))

  
  script.rm.
    dwap.udata = {
      menu_locn:  '!{udata.menu_locn}',
      userid:     '!{udata.userid}',
      name_first: '!{udata.name_first}',
      name_last:  '!{udata.name_last}',
      dept:       '!{udata.department}',
      home:       '!{udata.hpage}',
      tasks:      '!{udata.tasks}',
      groups:     '!{udata.groups}',
      language:   '!{udata.language}',
    };
    dwap.reps = JSON.parse('!{reps}');
    dwap.lang = JSON.parse('!{lang}');
    dwap.codata = !{JSON.stringify($.codata)};
    rm();

  if( (udata.menu_locn=='auto' && small) || udata.menu_locn=='top')
  
    div#layout.easyui-layout(data-options="fit: true")
      div(data-options="region:'north',_tools:'#topbutwr'" style="height:32px;background:#EEEEEE;").opaque
        +mainleft()
        span.vert-sep        
        +mainmenu()
        span.vert-sep
        +mainright()
        span.vert-sep
        #toolbut(style="display:inline-block;")
        +sysbut()
        #crumbs
              
      script.
        $('#mainmenu .easyui-menu').menu({
            onClick:function(node){
              if(node.target.submenu) return false;
              menuselect(node);
              //repmenus(node);
              trclick(node);
            }
        });
        
        $('.menu .menu-item').on("contextmenu", function (e) {
          e.preventDefault();
          var node = $(e.target).closest('.menu-item');
          
          if(node.length > 0){
            $('#mencm').attr('hovid',node.attr('id')).menu('show',{left:e.pageX,top:e.pageY});
          }
        })

      div(data-options="region:'center'")#west
        #content(fit="true" style="")
         
  else if( (udata.menu_locn=='auto' && !small) || udata.menu_locn=='left') 
    div#layout.easyui-layout(data-options="fit: true")
      //-div#west(data-options="region:'west',split:true,border:false, collapsible:true" _title="Home" style="width: 200px;")
        //-ul#westMenu.hide(data-reps='#{reps}' data-utype='#{udata.utype}' data-home='#{udata.hpage}' data-uid="#{udata.userid}" pdf='#{udata.userid}'+'.pdf')
        div(style="padding: 0 4px 0 4px; color:#AAAAAA; height:31px;position:relative;border-right:none;border-top:none;line-height:31px;").tabs-tool
          .two
            div.left(style="")
              |Home
            div.right
              label(style="margin-right:6px;") Autohide
              input#autohide(type="checkbox")
      
      div#west(data-options="region:'west',split:true,border:false, collapsible:true" title="Home" style="width: 220px;")
        +westmenu()
      
      div#center(region='center' title=' ' data-options="tools:'#topbutwr'" style="margin-top:none;").hide
        #topbutwr(class="xxx")
          +mainleft()
          span.vert-sep
          +mainright()
          span.vert-sep
          #toolbut(style="display:inline-block;")
          span.vert-sep
          +sysbut()
          #crumbs(style="display:inline-block;text-align:right")
          
        #content(fit="true")
    
  div#hidden(style="display:none")
  
    #calendar.easyui-calendar

    #_qbe_win.easyui-window(closed="true" title="Query By Exception")
      .easyui-layout(fit="true")
        div(region="west" style="width:400px;background:#FAFAFA;border-width:0 1px 0 0;")
          form#_qbe_form
          
          #_qbe_buts.center
            #_qbe_dgcol
            a#_qbe_clr
            a#_qbe_go
            
        div(region="center" style="padding:0px;").noborder
          //div.easyui-pagination(style="border-bottom:1px solid #DDDDDD;")
          div#_qbe_dg

    #mencm.easyui-menu(style="width:120px;")
      div(name="newtab" data-options="iconCls:'aicon-tab_add'") New Window
      div(name="pglink" data-options="iconCls:'aicon-link'") Get Page-Link
   
    #printmen(closed="true")
    
    #printopt.easyui-dialog(style="padding:10px;" title="Print Filters" data-options="closed:true,buttons:'#pbuts'")
      form#pops
        div#filters
        //-div#pbuts(style="text-align:center")    
          a.easyui-linkbutton#pdf(data-options="iconCls:'aicon-pdf'" style="margin-left:12px") PDF
          a.easyui-linkbutton#xls(data-options="iconCls:'aicon-xls'") Excel
          a.easyui-linkbutton#prx(data-options="iconCls:'aicon-cancel'" style="margin-left:12px") Cancel
    
    #docview.easyui-window(closed="true" title="Document View")
      iframe(scrolling='no' frameborder='no' style="width:100%; height:100%")

    #pentaho.easyui-window(closed="true" title="Pure Reports")
      iframe#ifpho(scrolling='no' frameborder='no' style="width:210mm; height:75vh")
    
    #help.easyui-window(style="width:50%; height:50%; padding:10px;" closed="true")
  
    #filesel.easyui-window(data-options="closed:true" title="File Upload" style="width:350px; height:450px;padding:12px;")
      #filetree
  
    #filewin.easyui-window(data-options="modal:true, closed:true" title="File Upload")
      form#fileup(enctype="multipart/form-data")
        .fitem(style="display:block;_width:300px;")
          label Progress
          #prog.easyui-progressbar(style="width:207px;")
        
        .fitem
          label Select File
          input#fname.easyui-filebox(name="fname" required="required")
      
        .fitem
          label Description
          input#uldesc.easyui-textbox(name="description" required="required")

        .fitem
          label Version
          input#rver.easyui-textbox(name="rver")
        
        div.buts
          .easyui-linkbutton#upbut(data-options="iconCls:'aicon-arrow_up', disabled:true") Upload
          .easyui-linkbutton(style="margin-left:12px;" data-options="iconCls:'aicon-cancel',onClick:function(){$('#filewin').window('close')}") Cancel


    #filetree.easyui-window(data-options="modal:true,closed:true")
      div.easyui-layout(data-options="fit:true,border:false")
        div(data-options="region:'west',split:false" style="width:420px;background:#FAFAFA;padding:12px;") 
                     
        div(data-options="region:'center'")
  
    #cbonav
      span.nav
        .cbnav.bak.easyui-linkbutton(data-options="iconCls:'icon-left',disabled:true")
        .cbnav.fwd.easyui-linkbutton(data-options="iconCls:'icon-right',disabled:true")

    +sysmenu()
  
  .window-mask
